on:
  workflow_call:
    # pull_request_review:
    #   types: [submitted]
    inputs:
      event:
        required: true
        type: string
      course_id:
        required: true
        type: string
      available_assignments:
        required: true
        type: string

jobs:
  on-changes-requested:
    runs-on: ubuntu-latest
    steps:
      - name: Create comment
        id: created_comment
        run: |
          cat << EOF >> $GITHUB_OUTPUT
          myoutput<<EOM
          Review State: ${{ fromJson(inputs.event).review.state }}
          Review URL: ${{ fromJson(inputs.event).review.html_url }}

          Review Comment:
          ${{ fromJson(inputs.event).review.body }}

          Reviewer: ${{ fromJson(inputs.event).review.user.login }}
          EOM
          EOF

      - uses: bth-python/utils/.github/actions/get-assignment-id@main
        id: resolve
        with:
          available_assignments: ${{ inputs.available_assignments }}
          pull_request: ${{ toJson(fromJson(inputs.event).pull_request) }}

      - name: Update Canvas with need to fix
        uses: bth-python/utils/.github/actions/update-canvas@main
        with:
          grade: "Ux"
          comment: "${{ steps.created_comment.outputs.myoutput }}"
          canvas_api_token: ${{ secrets.CANVAS_API_TOKEN }}
          course_id: ${{inputs.course_id}}
          assignment: ${{ steps.resolve.outputs.assignment }}
