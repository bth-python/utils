name: Decider Workflow

on:
  workflow_call:
    inputs:
      course_id:
        required: true
        type: string
      available_assignments:
        required: true
        type: string
      student_id:
        required: true
        type: string
      kmom_paths:
        required: true
        type: string

jobs:

  on-tag:
    if: startsWith(github.ref, 'refs/tags/')
    uses: bth-python/utils/.github/workflows/tester.yml@main
    with:
      kmom_paths: ${{ inputs.kmom_paths }}
    secrets: inherit

  on-labeled:
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'labeled' && ( github.event.label.name == 'Submitted' || github.event.label.name == 'Re-submitted' )  && github.base_ref != 'bth/submit/test-gitconfig'}}
    uses: bth-python/utils/.github/workflows/labeled.yml@main
    with:
      course_id: ${{ inputs.course_id }}
      available_assignments: ${{ inputs.available_assignments }}
      student_id: ${{ inputs.student_id }}
      kmom_paths: ${{ inputs.kmom_paths }}
    secrets: inherit

  on-pr-opened:
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'opened' && github.base_ref != 'bth/submit/test-gitconfig'}}
    uses: bth-python/utils/.github/workflows/submit_to_canvas.yml@main
    with:
      course_id: ${{ inputs.course_id }}
      available_assignments: ${{ inputs.available_assignments }}
      student_id: ${{ inputs.student_id }}
    secrets: inherit

  on-requested-change:
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'labeled' && github.event.label.name == 'Needs improvement' && github.base_ref != 'bth/submit/test-gitconfig'}}
    uses: bth-python/utils/.github/workflows/request_change.yml@main
    with:
      course_id: ${{ inputs.course_id }}
      student_id: ${{ inputs.student_id }}
      available_assignments: ${{ inputs.available_assignments }}
    secrets: inherit

  on-pr-merged:
    if: ${{ github.event_name == 'pull_request_review' && github.event.review.state == 'approved' && github.base_ref != 'bth/submit/test-gitconfig' }}
    uses: bth-python/utils/.github/workflows/on_merge.yml@main
    with:
      course_id: ${{ inputs.course_id }}
      student_id: ${{ inputs.student_id }}
      available_assignments: ${{ inputs.available_assignments }}
    secrets: inherit

  on-pr-not-approved:
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'labeled' && github.event.label.name == 'Submission not approved' && github.base_ref != 'bth/submit/test-gitconfig'}}
    uses: bth-python/utils/.github/workflows/not_approved.yml@main
    with:
      course_id: ${{ inputs.course_id }}
      available_assignments: ${{ inputs.available_assignments }}
      student_id: ${{ inputs.student_id }}
    secrets: inherit

  on-pr-closed:
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' && !github.event.pull_request.merged == true && github.base_ref != 'bth/submit/test-gitconfig' }}
    uses: bth-python/utils/.github/workflows/closed_pr.yml@main
    with:
      course_id: ${{ inputs.course_id }}
      available_assignments: ${{ inputs.available_assignments }}
      student_id: ${{ inputs.student_id }}
    secrets: inherit

  on-pr-opened-test-gitconfig:
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'opened' && github.base_ref == 'bth/submit/test-gitconfig' }}
    uses: bth-python/utils/.github/workflows/test-gitconfig.yml@main
    with:
      course_id: ${{ inputs.course_id }}
      available_assignments: ${{ inputs.available_assignments }}
      student_id: ${{ inputs.student_id }}
    secrets: inherit

  # on-other:
  #   if:
  #     ${{ !(inputs.event_name == 'pull_request' && inputs.pr_action == 'opened')
  #     && !(inputs.event_name == 'pull_request_review' && inputs.review_state == 'submitted')
  #     && !(inputs.event_name == 'push') }}
  #   uses: ./.github/workflows/workflow-for-other.yml
