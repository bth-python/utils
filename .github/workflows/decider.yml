name: Decider Workflow

on:
  workflow_call:
    inputs:
      event_name:
        required: true
        type: string
      event:
        required: true
        type: string
      pr_action:
        required: false
        type: string
      review_state:
        required: false
        type: string
      course_id:
        required: true
        type: string
      available_assignments:
        required: true
        type: string
      student_id:
        required: true
        type: string
      kmom_paths:
        required: true
        type: string

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Debug context
        run: |
          echo "github.ref: ${{ github.ref }}"
          echo "github.head_ref: ${{ github.head_ref }}"
          echo "github.base_ref: ${{ github.base_ref }}"
          echo "github.event_name: ${{ github.event_name }}"
          echo "event_name: ${{ github.event_name }}"
          echo "pr_action: ${{ github.event.action || '' }}"
          echo "review_state: ${{ github.event.review.state || '' }}"
  on-pr-merged:
    if: ${{ inputs.event_name == 'pull_request' && fromJson(inputs.event).pull_request.merged == true && github.base_ref != 'bth/submit/test-gitconfig' }}
    uses: bth-python/utils/.github/workflows/on_merge.yml@dev
    with:
      course_id: ${{ inputs.course_id }}
      student_id: ${{ inputs.student_id }}
      available_assignments: ${{ inputs.available_assignments }}
      event: ${{ inputs.event }}
    secrets: inherit

  on-pr-closed:
    if: ${{ inputs.event_name == 'pull_request' && inputs.pr_action == 'closed' && !fromJson(inputs.event).pull_request.merged == true && github.base_ref != 'bth/submit/test-gitconfig' }}
    uses: bth-python/utils/.github/workflows/closed_pr.yml@dev
    with:
      pr_action: ${{ inputs.pr_action }}
      event: ${{ inputs.event }}
      course_id: ${{ inputs.course_id }}
      available_assignments: ${{ inputs.available_assignments }}
      student_id: ${{ inputs.student_id }}
    secrets: inherit

  on-pr-opened:
    if: ${{ (inputs.event_name == 'pull_request' && inputs.pr_action == 'opened' && github.base_ref != 'refs/heads/bth/submit/test-gitconfig') || github.event_name == 'workflow_dispatch'}}
    uses: bth-python/utils/.github/workflows/examiner.yml@dev
    with:
      pr_action: ${{ inputs.pr_action  }}
      event: ${{ inputs.event }}
      course_id: ${{ inputs.course_id }}
      available_assignments: ${{ inputs.available_assignments }}
      student_id: ${{ inputs.student_id }}
      kmom_paths: ${{ inputs.kmom_paths }}
    secrets: inherit

  on-requested-change:
    if: ${{ inputs.event_name == 'pull_request_review' && inputs.review_state == 'changes_requested' && github.base_ref != 'bth/submit/test-gitconfig' }}
    uses: bth-python/utils/.github/workflows/need_fix.yml@dev
    with:
      event: ${{ inputs.event }}
      course_id: ${{ inputs.course_id }}
      student_id: ${{ inputs.student_id }}
      available_assignments: ${{ inputs.available_assignments }}
    secrets: inherit

  on-pr-opened-test-gitconfig:
    if: ${{ inputs.event_name == 'pull_request' && inputs.pr_action == 'opened' && github.base_ref == 'bth/submit/test-gitconfig' }}
    uses: bth-python/utils/.github/workflows/test-gitconfig.yml@dev
    with:
      pr_action: ${{ inputs.pr_action }}
      event: ${{ inputs.event }}
      course_id: ${{ inputs.course_id }}
      available_assignments: ${{ inputs.available_assignments }}
      student_id: ${{ inputs.student_id }}
    secrets: inherit

  # on-other:
  #   if:
  #     ${{ !(inputs.event_name == 'pull_request' && inputs.pr_action == 'opened')
  #     && !(inputs.event_name == 'pull_request_review' && inputs.review_state == 'submitted')
  #     && !(inputs.event_name == 'push') }}
  #   uses: ./.github/workflows/workflow-for-other.yml
