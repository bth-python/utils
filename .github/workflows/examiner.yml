name: Reusable Deploy

on:
  workflow_call:
    inputs:
      pr_action:
        required: true
        type: string
      event:
        required: true
        type: string
      course_id:
        required: true
        type: string
      available_assignments:
        required: true
        type: string
      student_id:
        required: true
        type: string
      kmom_paths:
        required: true
        type: string

jobs:
  submit-canvas:
    if: ${{ inputs.pr_action == 'opened' }}
    runs-on: ubuntu-latest
    steps:
      - name: Create body
        id: created_body
        run: |
          cat << EOF >> $GITHUB_OUTPUT
          myoutput<<EOM
          Pull Request action: ${{ inputs.pr_action }}<br>
          <br>
          <h2>${{github.event.pull_request.title}}<br></h2>
          ${{github.event.pull_request.body}}<br>
          <br>
          PR URL: <a class='inline_disabled' href='${{ fromJson(inputs.event).pull_request.html_url }}' target='_blank' rel='noopener noreferrer'>${{ fromJson(inputs.event).pull_request.html_url }}</a>
          EOM
          EOF

      - uses: bth-python/utils/.github/actions/get-assignment-id@main
        id: resolve
        with:
          available_assignments: ${{ inputs.available_assignments }}
          pull_request: ${{ toJson(fromJson(inputs.event).pull_request) }}

      - name: Update Canvas result from tests
        uses: bth-python/utils/.github/actions/update-canvas@main
        with:
          subcommand: "submit_assignment"
          comment: "${{ steps.created_body.outputs.myoutput }}"
          canvas_api_token: ${{ secrets.CANVAS_API_TOKEN }}
          student_id: ${{ inputs.student_id }}
          course_id: ${{inputs.course_id}}
          assignment_id: ${{ steps.resolve.outputs.assignment }}

  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      labs: ${{ steps.set-matrix.outputs.labs }}
      kmoms: ${{ steps.set-matrix.outputs.kmoms }}

    steps:
      - name: Extract labs and kmoms based on PR branch
        id: set-matrix
        run: |
          BRANCH="$BRANCH_NAME"
          echo "ðŸ“Œ Branch: $BRANCH"

          LABS=$(echo '${{ inputs.kmom_paths }}' | jq -c --arg b "$BRANCH" '.[$b].labs // []')
          KMOMS=$(echo '${{ inputs.kmom_paths }}' | jq -c --arg b "$BRANCH" '.[$b].kmoms // []')

          echo "âœ… Labs: $LABS"
          echo "âœ… Kmoms: $KMOMS"

          echo "labs={\"folder\":$LABS}" >> $GITHUB_OUTPUT
          echo "kmoms={\"folder\":$KMOMS}" >> $GITHUB_OUTPUT

  run-labs:
    needs: [generate-matrix]
    if: needs.generate-matrix.outputs.labs != '{"folder":[]}'
    runs-on: ubuntu-latest

    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.labs) }}

    steps:
      - name: setup-python
        uses: bth-python/utils/.github/actions/setup-python@main

      - name: "Validate code"
        run: uv run ruff check ${{ matrix.folder }}
        continue-on-error: true

      - name: Run lab test in ${{ matrix.folder }}
        continue-on-error: true
        run: |
          echo "ðŸ”¬ Running lab: ${{ matrix.folder }}"
          uv run ${{ matrix.folder }}/lab.py

  run-kmoms:
    needs: [generate-matrix]
    if: needs.generate-matrix.outputs.kmoms != '{"folder":[]}'
    runs-on: ubuntu-latest

    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.kmoms) }}

    steps:
      - name: setup-python
        uses: bth-python/utils/.github/actions/setup-python@main

      - name: "Validate code"
        run: uv run ruff check $(echo "${{ matrix.folder }}" | sed 's/tests/src/')

      - name: Run kmom test in ${{ matrix.folder }}
        run: |
          echo "ðŸ”¬ Running kmom: ${{ matrix.folder }}"
          uv run tester -f ${{ matrix.folder }}

      - name: Run extra tests in ${{ matrix.folder }}
        continue-on-error: true
        run: |
          echo "ðŸ”¬ Running extras: ${{ matrix.folder }}. It is OK if these tests fail. It will not affect your grade"
          uv run tester -f -e ${{ matrix.folder }}

  label-on-success:
    needs: [run-kmoms, run-labs]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Add "PG" label
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.READ_ORG_TOKEN }}
          labels: "PG"
      - name: Remove "TUx" label
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          github_token: ${{ secrets.READ_ORG_TOKEN }}
          labels: "TUx"

  label-on-failure:
    needs: [run-kmoms, run-labs]
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Add "failing" label
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.READ_ORG_TOKEN }}
          labels: "TUx"
      - name: Remove "PG" label
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          github_token: ${{ secrets.READ_ORG_TOKEN }}
          labels: "PG"

  grade-canvas:
    needs: [run-kmoms, run-labs]
    runs-on: ubuntu-latest
    if: always()
    env:
      OUTCOME: ${{ (needs.run-kmoms.result == 'success' && needs.run-labs.result == 'success') && 'All tests have passed.' || 'Something failed, look through logs to see what you need to fix.' }}
    steps:
      - name: Create comment
        id: created_comment
        run: |
          cat << EOF >> $GITHUB_OUTPUT
          myoutput<<EOM
          Pull Request action: ${{ inputs.pr_action }}
          Status: $OUTCOME

          Action URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOM
          EOF

      - uses: bth-python/utils/.github/actions/get-assignment-id@main
        id: resolve
        with:
          available_assignments: ${{ inputs.available_assignments }}
          pull_request: ${{ toJson(fromJson(inputs.event).pull_request) }}

      - name: Set grade variable
        id: set_grade
        run: echo "grade=${{ (needs.run-kmoms.result == 'success' && needs.run-labs.result == 'success') && 'PG' || 'TUx' }}" >> $GITHUB_OUTPUT

      - name: Add label
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.READ_ORG_TOKEN }}
          labels: "${{ steps.set_grade.outputs.grade }}"

      - name: Update Canvas result from tests
        uses: bth-python/utils/.github/actions/update-canvas@main
        continue-on-error: false
        with:
          subcommand: "grade_submission"
          grade: "${{ steps.set_grade.outputs.grade }}"
          comment: "${{ steps.created_comment.outputs.myoutput }}"
          canvas_api_token: ${{ secrets.CANVAS_API_TOKEN }}
          student_id: ${{ inputs.student_id }}
          course_id: ${{inputs.course_id}}
          assignment_id: ${{ steps.resolve.outputs.assignment }}
